# H2 Break and Unbreak

## Tiivistelmät

OWASP Top 10: A01 Broken Access Control

- Virheet käyttöoikeuksien hallinnassa johtavat usein luvattoman tiedon paljastumiseen tai pääsyn suorittamaan toimintoja, joihin käyttäjällä ei ole oikeutta.
- Hallinta tulee toteuttaa palvelinpuolella, jossa hyökkääjä ei voi muokata asetuksia
- Oikeudet tulisi oletusarvoisesti kieltää


Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf

  - Webbiservereillä on usein piilotettuja hakemistoja, joita voidaan yrittää löytää manuaalisesti kokeilemalla eri vaihtoehtoja ``` /secret, /.svn /admin```
  - Fuffin avulla tämä voidaan tehdä automaattisesti ja säästää valtava määrä aikaa

PortSwigger: Access control vulnerabilities and privilege escalation

- Älä koskaan luota pelkkään "piilottamiseen" oikeuksien hallinnassa
- Käytä mieluiten vain yhtä koko sovelluksen laajuista mekanismia valvonnassa
- Tarkasta ja testaa käyttöoikeudet säännöllisesti

Karvinen 2006: Report Writing (in Finnish)

- Raportti tulee kirjottaa siten, että kuka tahansa samassa ympäristössä oleva pääsee samaan tulokseen
- Vikailmoitukset myös tärkeitä, ellei tärkeimpiä, ne tulee myös raportoida


## a.) Break into 010-staff-only

Tehtävässä käytetty virtuaalikone: <img width="452" height="242" alt="image" src="https://github.com/user-attachments/assets/27f815b0-93f1-4c59-8d53-222ad83fb3d1" />

Kokeillaan ensin syöttää pin kenttään ```'OR+1=1--```
Ja saadaan tulostus "Please enter a number", tästä kokeilin seuraavaksi muuttaa type="number", numeroiden sijaan kirjaimet, ja kenttään uudestaan ```'OR+1=1--```
Tämä onnistui, mutta ei saatu haluttua salasanaa: <img width="1030" height="312" alt="image" src="https://github.com/user-attachments/assets/8c29bb28-fefb-4d24-93a7-717021b6ce9e" />

Katsoin Portswiggeristä apua ja löysin UNION ATTACK, josta ratkaisu saatiin: <img width="503" height="78" alt="image" src="https://github.com/user-attachments/assets/87ca4536-be8e-45f9-b7c0-e4f006418e64" />

<img width="905" height="151" alt="image" src="https://github.com/user-attachments/assets/fcc833fe-7114-4db4-936d-75a1b8012ca2" />

## b.) Fix the 010-staff-only

Tähän kohtaan itsellä loppui täysin keinot kesken, enkä tiennyt mistä aloittaa, joten katsoin vinkin. Muutetaan koodia siten, että käytetään parametrisoituja kyselyitä. Alkuperäinen versio oli altis hyökkäykselle, sillä käyttäjän syöte on suoraan SQL-lauseessa. 

Korjataan koodi: <img width="622" height="146" alt="image" src="https://github.com/user-attachments/assets/566a4dc8-c0cf-4d79-aad7-ae5f4fce5e86" />


## c.) Solve dirfuzt-1

Käynnistetään verkkosivu ja annetaan ohjeiden mukainen komento ```./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ```
<img width="384" height="278" alt="image" src="https://github.com/user-attachments/assets/99664d4b-239d-40d7-993d-6b243a483d6f" />

Saadaan tulostus, josta nopeasti huomataan, että koko 154 toistuu, joten filtröidään se seuraavaksi ```./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 154```

Ja enää jäljellä muutama vaihtoehtoa! <img width="787" height="499" alt="image" src="https://github.com/user-attachments/assets/a515463c-19c6-45be-9b0a-8b5e5bd57148" />
>

Ensimmäinen osuma <img width="567" height="193" alt="image" src="https://github.com/user-attachments/assets/de0f85be-5886-4140-9ec7-bcb2aecf08a1" />

Ja toinen osuma <img width="557" height="182" alt="image" src="https://github.com/user-attachments/assets/0aa43b61-407a-4ffe-b9fc-828c1bff8293" />

## d.)  020-your-eyes-only

Tehdään kaikki annetut vaiheet ja avataan sivu <img width="1245" height="262" alt="image" src="https://github.com/user-attachments/assets/b79c85ec-06d1-43de-ac3c-72d13af1e9ed" />

Kokeillaan samaa kuin edellisessä tehtävässä: ```./ffuf -w common.txt -u http://127.0.0.1:8000/FUZZ```

Saadaan yksi tulos: <img width="848" height="95" alt="image" src="https://github.com/user-attachments/assets/dc4369eb-3e36-4fd3-97c5-93986b099377" />

Sivu näyttää nyt tältä: <img width="1044" height="356" alt="image" src="https://github.com/user-attachments/assets/5daa43d4-a825-4c2c-84d7-7ad711fb91ec" />

Kokeillaan päästä sisälle normaalina käyttäjänä, eli luodaan omat tunnukset ja kokeillaan uudestaan

Kun pääsimme sisään, lisätään ```admin-console``` urliin

Ja sisällä! <img width="608" height="292" alt="image" src="https://github.com/user-attachments/assets/2d0ef8ba-a6a0-48c5-b17f-f55d51bcbb55" />


## e.) Fix the 020-your-eyes-only

Koodin korjaamiseen liittyvissä tehtävissä vaikeuksia, katsoin vihjeen. Etsitään oikea tiedosto views.py ja tarkastellaan sitä

Koodista huomataan, että viimeisellä riviltä puuttuu olennainen osa ```self.reguest.user.is_staff```

<img width="1093" height="283" alt="image" src="https://github.com/user-attachments/assets/e44efaa4-537b-473f-b94a-bfbfdad8cc8c" />

Tämän korjaaminen siis varmistaa, että Admin näkymän saa näkyviin vain jos käyttäjä oikeasti on "staffia"

Onnistunut lopputulos : <img width="733" height="188" alt="image" src="https://github.com/user-attachments/assets/1cc1ce4d-3d9c-45c7-8501-8d85cf0e2fee" />

## Lähteet

Karvinen, T. (2006). Raportin kirjoittaminen.
https://terokarvinen.com/2006/raportin-kirjoittaminen-4/

Karvinen, T. (2023). Fuzz URLs – Find Hidden Directories.
https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/

Karvinen, T. (2024). Hack’n Fix.
https://terokarvinen.com/hack-n-fix/

OWASP. OWASP Top 10 – A01:2021 Broken Access Control.
https://owasp.org/Top10/A01_2021-Broken_Access_Control/

PortSwigger. Access Control Vulnerabilities.
https://portswigger.net/web-security/access-control

PortSwigger. SQL Injection – Union Attacks.
https://portswigger.net/web-security/sql-injection/union-attacks

Tehtävässä on käytetty Microsoft Copilot-tekoälyä apuna koodin tarkastelussa.
